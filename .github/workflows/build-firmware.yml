# Build and Release DexArm Firmware
#
# This workflow builds the Marlin firmware for DexArm and attaches
# the binary to GitHub releases for automatic updates via Wade Robotics Studio.
#
# Triggers:
# - On push to main/master (builds but doesn't release)
# - On release creation (builds and attaches binary to release)
# - Manual trigger via workflow_dispatch

name: Build Firmware

on:
  push:
    branches: [main, master]
    paths:
      - 'Marlin/**'
      - 'platformio.ini'
      - '.github/workflows/build-firmware.yml'
  
  release:
    types: [created]
  
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release with the built firmware'
        required: false
        type: boolean
        default: false

env:
  PLATFORMIO_ENV: DEXARM_V3_2

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      
      - name: Build firmware
        run: |
          pio run -e ${{ env.PLATFORMIO_ENV }}
      
      - name: Get firmware info
        id: firmware_info
        run: |
          FIRMWARE_PATH=".pio/build/${{ env.PLATFORMIO_ENV }}/firmware.bin"
          
          if [ ! -f "$FIRMWARE_PATH" ]; then
            echo "Error: firmware.bin not found at $FIRMWARE_PATH"
            exit 1
          fi
          
          SIZE=$(stat -f%z "$FIRMWARE_PATH" 2>/dev/null || stat -c%s "$FIRMWARE_PATH")
          SHA256=$(sha256sum "$FIRMWARE_PATH" | cut -d' ' -f1)
          
          echo "path=$FIRMWARE_PATH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "## Firmware Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $SIZE bytes ($(echo "scale=1; $SIZE/1024" | bc) KB)" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256:** \`$SHA256\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate firmware
        run: |
          FIRMWARE_PATH="${{ steps.firmware_info.outputs.path }}"
          
          # Check file size (should be between 1KB and 960KB)
          SIZE=${{ steps.firmware_info.outputs.size }}
          if [ $SIZE -lt 1024 ]; then
            echo "Error: Firmware too small ($SIZE bytes)"
            exit 1
          fi
          if [ $SIZE -gt 983040 ]; then
            echo "Error: Firmware too large ($SIZE bytes)"
            exit 1
          fi
          
          # Validate ARM vector table
          # First 4 bytes = Stack Pointer (should point to SRAM: 0x20000000+)
          # Next 4 bytes = Reset Handler (should point to Flash: 0x08000000+)
          SP=$(xxd -l 4 -e "$FIRMWARE_PATH" | awk '{print $2}')
          RESET=$(xxd -s 4 -l 4 -e "$FIRMWARE_PATH" | awk '{print $2}')
          
          echo "Stack Pointer:  0x$SP"
          echo "Reset Handler:  0x$RESET"
          
          # Check SP points to SRAM (0x20000000 - 0x20030000)
          SP_DEC=$((16#$SP))
          if [ $SP_DEC -lt $((16#20000000)) ] || [ $SP_DEC -gt $((16#20030000)) ]; then
            echo "Warning: Stack pointer may not point to SRAM"
          fi
          
          # Check Reset Handler points to Flash (0x08000000 - 0x08100000)
          RESET_DEC=$((16#$RESET))
          if [ $RESET_DEC -lt $((16#08000000)) ] || [ $RESET_DEC -gt $((16#08100000)) ]; then
            echo "Warning: Reset handler may not point to Flash"
          fi
          
          echo "Firmware validation passed!"
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.PLATFORMIO_ENV }}
          path: ${{ steps.firmware_info.outputs.path }}
          retention-days: 30
      
      # Attach to release if this is a release event
      - name: Attach firmware to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.firmware_info.outputs.path }}
          append_body: true
          body: |
            
            ---
            ### Firmware Binary
            - **File:** `firmware.bin`
            - **Size:** ${{ steps.firmware_info.outputs.size }} bytes
            - **SHA256:** `${{ steps.firmware_info.outputs.sha256 }}`
            - **Target:** ${{ env.PLATFORMIO_ENV }}
            
            ### Installation
            Flash via Wade Robotics Studio or use M2002/M2003 bootloader commands.
      
      # Create release if manually triggered with create_release=true
      - name: Create release (manual trigger)
        if: github.event_name == 'workflow_dispatch' && inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Firmware Build ${{ github.run_number }}
          draft: true
          files: ${{ steps.firmware_info.outputs.path }}
          body: |
            ## DexArm Firmware
            
            Built from commit ${{ github.sha }}
            
            ### Firmware Binary
            - **File:** `firmware.bin`
            - **Size:** ${{ steps.firmware_info.outputs.size }} bytes
            - **SHA256:** `${{ steps.firmware_info.outputs.sha256 }}`
            - **Target:** ${{ env.PLATFORMIO_ENV }}
            
            ### Changes
            <!-- Add release notes here -->
            
            ### Installation
            Flash via Wade Robotics Studio or use M2002/M2003 bootloader commands.

  # Build for multiple targets (future expansion)
  build-matrix:
    if: false  # Disabled for now - enable when supporting multiple boards
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [DEXARM_V3_2, DEXARM_V3_1, DEXARM_V2]
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install platformio
      - run: pio run -e ${{ matrix.env }}
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.env }}
          path: .pio/build/${{ matrix.env }}/firmware.bin
